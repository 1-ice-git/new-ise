@model NewISE.Models.ViewModel.AnticipiViewModel

@{
    decimal idAttivitaAnticipi = Convert.ToDecimal(ViewData["idAttivitaAnticipi"]);
    decimal NumAttivazioni = Convert.ToDecimal(ViewData["NumAttivazioni"]);
    bool soloLettura = Convert.ToBoolean(ViewData["soloLettura"]);
    decimal ValsoloLettura = Convert.ToDecimal(ViewData["soloLettura"]);
    string txtReadOnly = "";
    if (soloLettura)
    {
        txtReadOnly = "readonly";
    }
}

<script src="~/Scripts/autoNumeric/autoNumeric-min.js"></script>


@Html.Hidden("hiPercentualeRichiesta")
@Html.Hidden("hiPercentualeAnticipoRichiesto")

<div style="padding-right: 10px;">
    <h4>Richiesta Anticipi</h4>
    <hr />
    <div class="table col-xs-12">
        <div class="row">
            <div class="col-xs-4">
            </div>

            <div class="col-xs-2 text-center" style="font-weight:bold">
                @Html.DisplayNameFor(model => model.ImportoPrevisto)
            </div>
            <div class="col-xs-2 text-center" style="font-weight:bold">
                @Html.DisplayNameFor(model => model.PercentualeAnticipoRichiesto)
            </div>
            <div class="col-xs-2 text-center" style="font-weight:bold">
                @Html.DisplayNameFor(model => model.ImportoPercepito)
            </div>
        </div>
        <div class="row">
            <div class="col-xs-4 text-right" style="padding-right:15px;font-weight:bold;padding-top:5px">
                Indennità di Prima Sistemazione:
            </div>
            <div class="col-xs-2">
                <input id="ImportoPrevisto" value="@Model.ImportoPrevisto" class="form-control " readonly style="text-align: right" />
            </div>
            <div class="col-xs-2">
                <input maxlength="3" onkeyup="CalcolaAnticipo();" id="PercentualeAnticipoRichiesto" value="@Model.PercentualeAnticipoRichiesto" class="form-control " @txtReadOnly style="text-align: right" />
            </div>
            <div>
                <div id="divLoader"  class="col-xs-2" hidden>
                    <img src="~/Immagini/Loading/loader.gif" style="width:100%" height="30"/>
                </div>
                <div id="divImportoPercepito" class="col-xs-2" >
                    <input id="ImportoPercepito" value="@Model.ImportoPercepito" class="form-control " readonly style="text-align: right" />
                </div>
            </div>
        </div>
    </div>

</div>

<script type="text/javascript">

    $("#PercentualeAnticipoRichiesto").focus(function() {
        $(this).select();
    });


    $("#PercentualeAnticipoRichiesto").autoNumeric('init',
	{
	    aSep: '.',
	    aDec: ',',
	    aSign: '',
	    vMin: 0,
	    vMax: 100
	});

    $("#ImportoPercepito").autoNumeric('init',
      {
          aSep: '.',
          aDec: ',',
          aSign: ''
      });



    $("#ImportoPrevisto").autoNumeric('init',
	{
	    aSep: '.',
	    aDec: ',',
	    aSign: '',
	    nSep: true
	});



    $('#hiPercentualeRichiesta').val(@Model.PercentualeAnticipoRichiesto);

    CalcolaAnticipo();

    function CalcolaAnticipo() {

            //debugger;
            var rotta = "/Anticipi/CalcolaAnticipo";
            var idAttivitaAnticipi = parseInt('@idAttivitaAnticipi');
            var percRichiesta = parseInt($("#PercentualeAnticipoRichiesto").val());
      
            if (!isNaN(percRichiesta))
            {
                $.ajax({
                type: "POST",
                url: rotta,
                data: { idAttivitaAnticipi: idAttivitaAnticipi, percRichiesta: percRichiesta },
                async: true,
                dataType: 'json',
                beforeSend: function () {
                    //debugger;
                    VerificaAutenticazione();
                    $("#divLoader").show();
                    $("#divImportoPercepito").hide();
                },
                success: function (result) {
                    //debugger;
                    if (result.err == "") {
                        var appo = result.importoPercepito;
                        var appo1 = appo.toString();
                        appo1 = appo1.replace(".", ",");
                            
                        $("#ImportoPercepito").val(appo1);

                        var percRichiesta_old = parseFloat($("#hiPercentualeRichiesta").val());

                        if (@ValsoloLettura==0 && percRichiesta_old != percRichiesta && percRichiesta>0) {
                            $("#btNotificaRichiestaAnticipi").removeAttr("disabled");
                            $("#btNotificaRichiestaAnticipi").removeClass("disabled");
                        } else
                        {
                            $("#btNotificaRichiestaAnticipi").attr("disabled", "disabled");
                            $("#btNotificaRichiestaAnticipi").addClass("disabled");
                        }
                    } else {
                        ErroreElaborazioneAjax(result.err);
                    }
                    $("#divLoader").hide();
                    $("#divImportoPercepito").show();

                },
                complete: function () {

                },
                error: function (jqXHR, textStatus, errorThrow) {
                    //debugger;
                    var msg = errorThrow.err;
                    ErroreElaborazioneAjax(msg);
                }

            });
        } else
        {
            $("#btNotificaRichiestaAnticipi").attr("disabled", "disabled");
            $("#btNotificaRichiestaAnticipi").addClass("disabled");
        }
    }
</script>
