@model NewISE.Models.DBModel.DipendentiModel

@{
    bool admin = Convert.ToBoolean(ViewBag.Amministratore);
    string matricola = Convert.ToString(ViewBag.Matricola);
}

<div id="divControlliDipendenti">
    <div class="form-horizontal">

        <div class="form-group">
            @Html.Label("lblNominativo", "Nominativo", new { @class = "control-label col-xs-3" })
            <div id="divCombo2" class="col-xs-9">
                <div class="select2-container select2-container--classic">
                    @Html.DropDownList("matricola", ViewBag.ListDipendentiGepeNominativo as IEnumerable<SelectListItem>, new { @id = "Nominativo", @class = "form-control select2 select2-select" })
                </div>
            </div>
        </div>
        <div class="form-group">
            <label for="dataAssunzione" class="col-xs-3 control-label">Data assunz.</label>
            <div class="col-xs-9">
                @if (Model != null && Model.dataAssunzione > DateTime.MinValue)
                {
                    <input id="dataAssunzione" name="dataAssunzione" type="datetime" value="@Model.dataAssunzione.ToShortDateString()" class="form-control" readonly />
                }
                else
                {
                    <input id="dataAssunzione" name="dataAssunzione" type="datetime" value="" class="form-control" readonly />
                }
            </div>
        </div>
        <div class="form-group">
            @Html.LabelFor(model => model.livelloDipendenteValido.Livello.DescLivello, htmlAttributes: new { @class = "control-label col-xs-3" })
            <div class="col-xs-9">
                @if (Model != null && Model.livelloDipendenteValido != null && Model.livelloDipendenteValido.Livello != null)
                {
                    <input id="livello" name="livello" type="text" value="@Model.livelloDipendenteValido.Livello.DescLivello" class="form-control" readonly />
                }
                else
                {
                    <input id="livello" name="livello" type="text" value="" class="form-control" readonly />
                }
            </div>
        </div>
        <div class="form-group">
            @Html.LabelFor(model => model.cdcGepe.descCDC, htmlAttributes: new { @class = "control-label col-xs-3" })
            <div class="col-xs-9">
                @if (Model != null && Model.cdcGepe != null)
                {
                    <input id="cdc" name="cdc" type="text" value="@Model.cdcGepe.descCDC" class="form-control" readonly />
                }
                else
                {
                    <input id="cdc" name="cdc" type="text" value="" class="form-control" readonly />
                }
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">
    //debugger;
    $("#hMatricola").val('@matricola');

    InfoTrasferimento('@matricola');
    //debugger;
    GestioneMenu();

    $("#Nominativo").change(function () {
        //debugger;
        FiltraDipendente();
    });

    function GestioneAbilitazioneMenu(matricola) {
        //debugger;

        if (MenuGestioneTrasferimento(matricola) == 1) {
            $("#lkGestioneTrasferimento").removeAttr("disabled");
            $("#mnGestioneTrasferimento").removeClass("disabled");
            $('#lkGestioneTrasferimento').attr('onClick', 'GestioneTrasferimento();');
        }
        else {
            $("#lkGestioneTrasferimento").attr("disabled", "disabled");
            $("#mnGestioneTrasferimento").addClass("disabled");
            $("#lkGestioneTrasferimento").removeAttr("onClick");
        }

        if (MenuMaggiorazioneFamiliare(matricola) == 1) {
            $("#lkMaggiorazioneFamiliare").removeAttr("disabled");
            $("#mnMaggiorazioneFamiliare").removeClass("disabled");
            $('#lkMaggiorazioneFamiliare').attr('onClick', 'MaggiorazioneFamiliare();');
        }
        else {
            $("#lkMaggiorazioneFamiliare").attr("disabled", "disabled");
            $("#mnMaggiorazioneFamiliare").addClass("disabled");
            $("#lkMaggiorazioneFamiliare").removeAttr("onClick");
        }

        //if (MenuRichiamo(matricola) == 1) {
        //    $("#lkRichiamo").removeAttr("disabled");
        //    $("#mnRichiamo").removeClass("disabled");
        //    $('#lkRichiamo').attr('onClick', 'Richiamo();');
        //}
        //else {
        //    $("#lkRichiamo").attr("disabled", "disabled");
        //    $("#mnRichiamo").addClass("disabled");
        //    $("#lkRichiamo").removeAttr("onClick");
        //}

        
            $("#lkRichiamo").removeAttr("disabled");
            $("#mnRichiamo").removeClass("disabled");
            $('#lkRichiamo').attr('onClick', 'Richiamo();');
        
        
    }

    function GestioneMenu() {
        //debugger;
        var matr = $("#Nominativo").val();

        if (matr != "" && matr != '0') {
            SvuotaTab();
            $("#lkNuovoTrasferimento").removeAttr("disabled");
            $("#mnNuovoTrasferimento").removeClass("disabled");

            GestioneAbilitazioneMenu(matr);

        }
        else {
            SvuotaTab();

            $("#lkNuovoTrasferimento").attr("disabled", "disabled");
            $("#mnNuovoTrasferimento").addClass("disabled");

            $("#lkGestioneTrasferimento").attr("disabled", "disabled");
            $("#mnGestioneTrasferimento").addClass("disabled");

            $("#lkMaggiorazioneFamiliare").attr("disabled", "disabled");
            $("#mnMaggiorazioneFamiliare").addClass("disabled");

            $("#lkMaggiorazioneAbitazione").attr("disabled", "disabled");
            $("#mnMaggiorazioneAbitazione").addClass("disabled");

            $("#lkCongediPermessi").attr("disabled", "disabled");
            $("#mnCongediPermessi").addClass("disabled");

            $("#lkSospensione").attr("disabled", "disabled");
            $("#mnSospensione").addClass("disabled");

            $("#lkRichiamo").attr("disabled", "disabled");
            $("#mnRichiamo").addClass("disabled");

            $("#lkIndennità").attr("disabled", "disabled");
            $("#mnIndennità").addClass("disabled");

            $("#lkRiepilogoVoci").attr("disabled", "disabled");
            $("#mnRiepilogoVoci").addClass("disabled");

        }

    }

    function SvuotaTab() {
        $("#tabNuovoTrasferimento").empty();
        $("#tabGestioneTrasferimento").empty();
        $("#tabMaggiorazioneFamiliare").empty();
        $("#tabMaggiorazioneAbitazione").empty();
        $("#tabCongediPermessi").empty();
        $("#tabSospensione").empty();
        $("#tabRichiamo").empty();
        $("#tabIndennita").empty();
        $("#RiepilogoVoci").empty();
    }

    $("#Nominativo").select2({
        placeholder: "Seleziona il nominativo",
        allowClear: true,
        language: "it",
        width: '300'

    });

    function MenuGestioneTrasferimento(matricola) {
        //debugger;
        var rotta = "/Trasferimento/VerirficaCompilazioneTrasferimento";
        var valoreRitorno = 0;

        if (matricola != "" && matricola != undefined) {
            $.ajax({
                type: "POST",
                url: rotta,
                data: { matricola: matricola },
                dataType: 'json',
                async: false,
                beforeSend: function () {
                    //debugger;
                    //VerificaAutenticazione();

                },
                success: function (result) {
                    //debugger;

                    if (result.err == "" || result.err == undefined) {
                        if (result.VerificaCompilazione == 1) {
                            valoreRitorno = 1;
                        }
                        else {
                            valoreRitorno = 0;
                        }
                    }

                    //InfoTrasferimento(matricola);
                    //GestioneMenu();
                },
                complete: function () {
                    //$("#divEffettoLoadAutNoDoc").hide("slow");
                    //                $("#Centro").getNiceScroll().resize();
                },
                error: function (jqXHR, textStatus, errorThrow) {
                    //debugger;
                    var msg = errorThrow.err;
                    AlertDialog(msg);
                }

            });
        }

        return valoreRitorno;
    }


    function MenuMaggiorazioneFamiliare(matricola) {
        //debugger;
        var rotta = "/Trasferimento/VerificaMaggiorazioneFamiliare";
        //da sostituire con
        //var rotta = "/Trasferimento/VerificaMaggiorazioneFamiliareByStatoTrasferimento";
        var valoreRitorno = 0;

        if (matricola != "" && matricola != undefined) {
            $.ajax({
                type: "POST",
                url: rotta,
                data: { matricola: matricola },
                dataType: 'json',
                async: false,
                beforeSend: function () {
                    //debugger;
                    //VerificaAutenticazione();

                },
                success: function (result) {
                    //debugger;

                    if (result.err == "" || result.err == undefined) {
                        if (result.idmaggiorazione != 0) {
                            valoreRitorno = 1;
                        }
                        else {
                            valoreRitorno = 0;
                        }
                    }

                    //InfoTrasferimento(matricola);
                    //GestioneMenu();
                },
                complete: function () {
                    //$("#divEffettoLoadAutNoDoc").hide("slow");
                    //                $("#Centro").getNiceScroll().resize();
                },
                error: function (jqXHR, textStatus, errorThrow) {
                    //debugger;
                    var msg = errorThrow.err;
                    AlertDialog(msg);
                }

            });
        }

        return valoreRitorno;
    }

    function MenuRichiamo(matricola) {
        debugger;
        var rotta = "/Trasferimento/VerificaRichiamo";
        
        var valoreRitorno = 0;

        if (matricola != "" && matricola != undefined) {
            $.ajax({
                type: "POST",
                url: rotta,
                data: { matricola: matricola },
                dataType: 'json',
                async: false,
                beforeSend: function () {
                    //debugger;
                    //VerificaAutenticazione();

                },
                success: function (result) {
                    //debugger;

                    if (result.err == "" || result.err == undefined) {
                        if (result.idmaggiorazione != 0) {
                            valoreRitorno = 1;
                        }
                        else {
                            valoreRitorno = 0;
                        }
                    }

                },
                complete: function () {
                    //$("#divEffettoLoadAutNoDoc").hide("slow");
                    //                $("#Centro").getNiceScroll().resize();
                },
                error: function (jqXHR, textStatus, errorThrow) {
                    //debugger;
                    var msg = errorThrow.err;
                    AlertDialog(msg);
                }

            });
        }

        return valoreRitorno;
    }

    function FiltraDipendente() {
        //debugger;
        var rotta = "/Dipendenti/DipendentiGepe";
        var matricola = $("#Nominativo").val();

        if (matricola != "" && matricola != undefined) {
            $.ajax({
                type: "POST",
                url: rotta,
                data: { matricola: matricola },
                dataType: 'html',
                beforeSend: function () {
                    //debugger;
                    //VerificaAutenticazione();
                    //$("#DialogNewDoc").dialog("destroy");
                    //$("#divEffettoLoadAutNoDoc").show("slow");
                    //$("#ContenitoreDipendentiGepe").empty();
                },
                success: function (result) {
                    //debugger;
                    //$("#divEffettoLoadAutNoDoc").hide("slow");
                    $("#ContenitoreDipendentiGepe").empty();
                    $("#ContenitoreDipendentiGepe").html(result);

                    //InfoTrasferimento(matricola);
                    //GestioneMenu();
                },
                complete: function () {
                    MenuDaVisualizzare();
                },
                error: function (jqXHR, textStatus, errorThrow) {
                    //debugger;
                    var msg = errorThrow.err;
                    AlertDialog(msg);
                }

            });
        }
    }

    function InfoTrasferimento(matricola) {
        //debugger;

        if (matricola == "") {
            return;
        }
        else {
            $("#hMatricola").val(matricola);
        }
        var rotta = "/Trasferimento/InfoTrasferimento";
        if (matricola != "") {
            $.ajax({
                type: "POST",
                url: rotta,
                data: { matricola: matricola },
                dataType: 'html',
                beforeSend: function () {
                    //debugger;
                    //VerificaAutenticazione();
                    //$("#DialogNewDoc").dialog("destroy");
                    //$("#divEffettoLoadAutNoDoc").show("slow");
                    //$("#ContenitoreDipendentiGepe").empty();
                },
                success: function (result) {
                    //debugger;
                    //$("#divEffettoLoadAutNoDoc").hide("slow");
                    $("#ContenitoreDatiTrasf").empty();
                    $("#ContenitoreDatiTrasf").html(result);

                    //RicercaDocumenti();

                },
                complete: function () {
                    //$("#divEffettoLoadAutNoDoc").hide("slow");
                    //                $("#Centro").getNiceScroll().resize();
                },
                error: function (jqXHR, textStatus, errorThrow) {
                    //debugger;
                    var msg = errorThrow.err;
                    AlertDialog(msg);
                }

            });
        }
    }

</script>